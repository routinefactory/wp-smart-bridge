name: Build and Release WordPress Plugin

# ===================================================================
# Workflow íŠ¸ë¦¬ê±°: Git íƒœê·¸ í‘¸ì‹œ ì‹œ ìë™ ì‹¤í–‰
# ì˜ˆ: git tag v2.6.5 && git push origin v2.6.5
# ===================================================================
on:
  push:
    tags:
      - 'v*'  # vë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  íƒœê·¸ (ì˜ˆ: v2.6.5, v3.0.0)

jobs:
  build-and-release:
    name: Build WordPress Plugin and Create GitHub Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # GitHub Release ìƒì„± ê¶Œí•œ
    
    steps:
      # ===============================================================
      # Step 1: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      # ===============================================================
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # ===============================================================
      # Step 2: ë²„ì „ ì •ë³´ ì¶”ì¶œ (íƒœê·¸ëª…ì—ì„œ)
      # ===============================================================
      - name: Extract Version from Tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Building version: $VERSION"
      
      # ===============================================================
      # Step 2.5: PHP ë¬¸ë²• ê²€ì‚¬ (Lint)
      # ===============================================================
      - name: Check PHP Syntax
        run: |
          echo "ğŸ” Checking PHP syntax..."
          find wp-smart-bridge -name "*.php" -print0 | xargs -0 -n1 php -l
          echo "âœ… PHP syntax check passed."

      # ===============================================================
      # Step 3: ZIP ì•„ì¹´ì´ë¸Œ ìƒì„± (WordPress í”ŒëŸ¬ê·¸ì¸ í‘œì¤€)
      # ===============================================================
      - name: Create WordPress Plugin ZIP
        run: |
          echo "ğŸ”¨ Creating plugin ZIP archive..."
          
          # wp-smart-bridge ë””ë ‰í† ë¦¬ë§Œ ì••ì¶•
          # ê°œë°œ íŒŒì¼ ì œì™¸: Git ê´€ë ¨, ë¬¸ì„œ, ì˜ˆì œ ì½”ë“œ, IDE ì„¤ì •
          cd wp-smart-bridge
          
          zip -r ../wp-smart-bridge.zip . \
            -x "*.git*" \
            -x "*.github/*" \
            -x "*.gitignore" \
            -x "*.DS_Store" \
            -x "*.vscode/*" \
            -x "*.idea/*" \
            -x "node_modules/*" \
            -x "*.log" \
            -x "*.tmp" \
            -x "tests/*" \
            -x "*.md" \
            -x "phpunit.xml*" \
            -x "composer.*"
          
          cd ..
          
          echo "âœ… ZIP archive created: wp-smart-bridge.zip"
          echo "ğŸ“¦ Archive size: $(du -h wp-smart-bridge.zip | cut -f1)"
      
      # ===============================================================
      # Step 4: ZIP íŒŒì¼ ê²€ì¦
      # ===============================================================
      - name: Verify ZIP Contents
        run: |
          echo "ğŸ” Verifying ZIP archive structure..."
          unzip -l wp-smart-bridge.zip | head -20
          
          # í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸
          if unzip -l wp-smart-bridge.zip | grep -q "wp-smart-bridge.php"; then
            echo "âœ… Main plugin file found"
          else
            echo "âŒ Main plugin file not found!"
            exit 1
          fi
          
          if unzip -l wp-smart-bridge.zip | grep -q "uninstall.php"; then
            echo "âœ… Uninstall file found"
          else
            echo "âŒ Uninstall file not found!"
            exit 1
          fi
      
      # ===============================================================
      # Step 5: GitHub Release ìƒì„± ë° ZIP ì²¨ë¶€
      # ===============================================================
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # ë¦´ë¦¬ìŠ¤ì— ì²¨ë¶€í•  íŒŒì¼
          files: wp-smart-bridge.zip
          
          # ìë™ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„± (ì»¤ë°‹ ê¸°ë¡ ê¸°ë°˜)
          generate_release_notes: true
          
          # ë¦´ë¦¬ìŠ¤ ì„¤ì •
          draft: false           # ì¦‰ì‹œ ê³µê°œ
          prerelease: false      # ì •ì‹ ë¦´ë¦¬ìŠ¤ (ë² íƒ€ ì•„ë‹˜)
          
          # ë¦´ë¦¬ìŠ¤ ì´ë¦„ ë° ë³¸ë¬¸
          name: "WP Smart Bridge v${{ steps.version.outputs.version }}"
          body: |
            ## ğŸš€ WP Smart Bridge v${{ steps.version.outputs.version }}
            
            ### ğŸ“¦ ì„¤ì¹˜ ë°©ë²•
            
            1. ì•„ë˜ **wp-smart-bridge.zip** íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            2. WordPress ê´€ë¦¬ì â†’ í”ŒëŸ¬ê·¸ì¸ â†’ ìƒˆë¡œ ì¶”ê°€ â†’ í”ŒëŸ¬ê·¸ì¸ ì—…ë¡œë“œ
            3. ZIP íŒŒì¼ ì„ íƒ í›„ ì„¤ì¹˜
            4. í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”
            
            ### ğŸ”„ ì—…ë°ì´íŠ¸ ë°©ë²• (ê¸°ì¡´ ì‚¬ìš©ì)
            
            **ìˆ˜ë™ ì—…ë°ì´íŠ¸**:
            1. ê¸°ì¡´ í”ŒëŸ¬ê·¸ì¸ ë¹„í™œì„±í™” ë° ì œê±° (ë°ì´í„°ëŠ” ë³´ì¡´ë¨)
            2. ì‹ ê·œ í”ŒëŸ¬ê·¸ì¸ ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ í›„ ì¬ì„¤ì¹˜
            3. í”ŒëŸ¬ê·¸ì¸ ì¬í™œì„±í™” â†’ ëª¨ë“  ì„¤ì •/ë§í¬ ìë™ ë³µì›
            
            ### ğŸ“Š ë°ì´í„° ë³´ì¡´ ë³´ì¥
            
            âœ… ì—…ë°ì´íŠ¸ ì‹œ ëª¨ë“  ë°ì´í„° ìë™ ë³´ì¡´:
            - ì œíœ´ ë§í¬ ë° ë‹¨ì¶• URL
            - í´ë¦­ ë¶„ì„ ë°ì´í„°
            - API í‚¤ ë° ì„¤ì •ê°’
            
            ### ğŸ“ ë³€ê²½ì‚¬í•­
            
            ìì„¸í•œ ë³€ê²½ ë‚´ì—­ì€ ì•„ë˜ "Full Changelog"ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
            
            ---
            
            **âš ï¸ ì°¸ê³ **: ì´ ë¦´ë¦¬ìŠ¤ëŠ” GitHub Actionsë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
        
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ===============================================================
      # Step 6: ì™„ë£Œ ì•Œë¦¼
      # ===============================================================
      - name: Release Complete
        run: |
          echo "ğŸ‰ Release v${{ steps.version.outputs.version }} published successfully!"
          echo "ğŸ“¥ Download URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
